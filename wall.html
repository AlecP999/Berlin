<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Escape The Wall — Berlin 1987</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0a0a0a; overflow: hidden; font-family: 'Courier New', monospace; }
  canvas { display: block; }

  #hud {
    position: fixed; top: 0; left: 0; right: 0;
    padding: 18px 28px; display: none;
    justify-content: space-between; align-items: flex-start;
    z-index: 10; pointer-events: none;
  }
  .hud-left, .hud-right { display: flex; flex-direction: column; gap: 5px; }
  .hud-label { font-size: 9px; letter-spacing: 3px; text-transform: uppercase; color: rgba(200,160,74,0.5); }
  .health-bar-outer { width: 180px; height: 5px; background: rgba(255,255,255,0.08); border: 1px solid rgba(200,160,74,0.2); }
  .health-bar-inner { height: 100%; background: linear-gradient(90deg, #c8a04a, #8b6914); transition: width 0.3s; }
  .health-bar-inner.low { background: linear-gradient(90deg, #cc3333, #881111); }
  #timerDisplay { font-size: 20px; letter-spacing: 4px; color: rgba(232,224,208,0.6); text-align: right; font-variant-numeric: tabular-nums; }
  #distDisplay { font-size: 10px; letter-spacing: 2px; color: rgba(232,224,208,0.3); text-align: right; }

  #damageFlash {
    position: fixed; inset: 0; z-index: 8;
    background: radial-gradient(ellipse at center, transparent 30%, rgba(180,0,0,0.6) 100%);
    opacity: 0; pointer-events: none; transition: opacity 0.1s;
  }

  #crosshair { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 10; pointer-events: none; opacity: 0.25; display: none; }
  #crosshair div { position: absolute; background: rgba(232,224,208,0.6); }
  #crosshair .h { width: 14px; height: 1px; top: 50%; left: 50%; transform: translate(-50%,-50%); }
  #crosshair .v { width: 1px; height: 14px; top: 50%; left: 50%; transform: translate(-50%,-50%); }

  #handsOverlay {
    position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
    z-index: 9; pointer-events: none; width: 280px; height: 180px; display: none;
  }
  .hand {
    position: absolute; bottom: -20px; width: 70px; height: 105px;
    border-radius: 10px 10px 4px 4px;
    background: linear-gradient(180deg, #c4956a, #a07850, #8b6540);
    box-shadow: inset -6px 0 12px rgba(0,0,0,0.3), inset 3px 0 8px rgba(255,200,150,0.12);
    transition: transform 0.12s ease;
  }
  .hand.left { left: 25px; transform: rotate(-8deg); }
  .hand.right { right: 25px; transform: rotate(8deg); }
  .hand .finger {
    position: absolute; top: -15px; width: 12px; height: 24px;
    background: linear-gradient(180deg, #c4956a, #a07850);
    border-radius: 6px 6px 3px 3px; box-shadow: inset -2px 0 3px rgba(0,0,0,0.2);
  }
  .hand.left .finger:nth-child(1) { left: 6px; top: -13px; transform: rotate(-4deg); }
  .hand.left .finger:nth-child(2) { left: 18px; top: -19px; }
  .hand.left .finger:nth-child(3) { left: 30px; top: -17px; }
  .hand.left .finger:nth-child(4) { left: 42px; top: -11px; transform: rotate(4deg); }
  .hand.right .finger:nth-child(1) { left: 6px; top: -11px; transform: rotate(-4deg); }
  .hand.right .finger:nth-child(2) { left: 18px; top: -17px; }
  .hand.right .finger:nth-child(3) { left: 30px; top: -19px; }
  .hand.right .finger:nth-child(4) { left: 42px; top: -13px; transform: rotate(4deg); }
  .hand .pl { position: absolute; width: 55%; height: 1px; left: 22%; background: rgba(0,0,0,0.13); border-radius: 1px; }
  .hand .pl:nth-of-type(5) { top: 35%; }
  .hand .pl:nth-of-type(6) { top: 50%; transform: rotate(-5deg); }
  .hand .pl:nth-of-type(7) { top: 63%; transform: rotate(3deg); }

  .climbing .hand.left { transform: rotate(-12deg) translateY(-35px) translateX(10px); }
  .climbing .hand.right { transform: rotate(12deg) translateY(5px) translateX(-10px); }
  .climbing.alt .hand.left { transform: rotate(-12deg) translateY(5px) translateX(10px); }
  .climbing.alt .hand.right { transform: rotate(12deg) translateY(-35px) translateX(-10px); }

  #startScreen {
    position: fixed; inset: 0; z-index: 100; background: #0d0c0a;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    text-align: center; gap: 18px;
  }
  #startScreen h1 { font-size: clamp(2rem,6vw,4.2rem); letter-spacing: 0.15em; color: #e8e0d0; text-shadow: 0 0 60px rgba(200,160,74,0.12); }
  #startScreen .sub { font-size: 11px; letter-spacing: 3px; text-transform: uppercase; color: rgba(232,224,208,0.3); max-width: 480px; line-height: 1.9; }
  #startScreen .ctrl { font-size: 10px; letter-spacing: 2px; color: rgba(232,224,208,0.18); line-height: 2.1; margin-top: 8px; }
  #startScreen .ctrl span { color: rgba(200,160,74,0.45); }
  #startBtn {
    margin-top: 18px; padding: 13px 48px; font-family: inherit;
    font-size: 11px; letter-spacing: 6px; text-transform: uppercase;
    color: #e8e0d0; background: none; border: 1px solid rgba(200,160,74,0.3);
    cursor: pointer; transition: all 0.3s;
  }
  #startBtn:hover { background: rgba(200,160,74,0.08); border-color: rgba(200,160,74,0.6); }

  #endScreen {
    position: fixed; inset: 0; z-index: 100; display: none; flex-direction: column;
    justify-content: center; align-items: center; text-align: center; gap: 14px;
  }
  #endScreen.show { display: flex; }
  #endScreen.victory { background: rgba(10,15,8,0.95); }
  #endScreen.defeat { background: rgba(20,5,5,0.95); }
  #endScreen h1 { font-size: clamp(1.8rem,5vw,3.5rem); letter-spacing: 0.12em; }
  #endScreen.victory h1 { color: #c8a04a; }
  #endScreen.defeat h1 { color: #aa2222; }
  #endScreen .stat { font-size: 11px; letter-spacing: 3px; text-transform: uppercase; color: rgba(232,224,208,0.35); line-height: 2.2; }
  #endScreen .stat strong { color: rgba(232,224,208,0.65); font-weight: normal; }
  .end-btn {
    margin-top: 6px; padding: 11px 38px; font-family: inherit;
    font-size: 10px; letter-spacing: 5px; text-transform: uppercase;
    color: #e8e0d0; background: none; border: 1px solid rgba(232,224,208,0.15);
    cursor: pointer; transition: all 0.3s; text-decoration: none; display: inline-block;
  }
  .end-btn:hover { border-color: rgba(232,224,208,0.4); }
  .end-btn.home { color: rgba(232,224,208,0.3); font-size: 9px; border-color: rgba(232,224,208,0.06); margin-top: 2px; }
</style>
</head>
<body>

<div id="startScreen">
  <h1>ESCAPE THE WALL</h1>
  <div class="sub">East Berlin, 1987. You must cross 150 meters of the death strip — sand, barbed wire, trenches, and concrete — under the guns of Grenztruppen border guards. Reach the western wall and climb to freedom.</div>
  <div class="ctrl">
    <span>WASD</span> move &nbsp; <span>ARROWS / MOUSE</span> look &nbsp; <span>SHIFT</span> sprint<br>
    <span>SPACE</span> jump &amp; climb &nbsp; Click to lock mouse
  </div>
  <button id="startBtn">BEGIN ESCAPE</button>
</div>

<div id="hud">
  <div class="hud-left">
    <div class="hud-label">Health</div>
    <div class="health-bar-outer"><div class="health-bar-inner" id="healthBar" style="width:100%"></div></div>
  </div>
  <div class="hud-right">
    <div id="timerDisplay">00:00</div>
    <div id="distDisplay">150m to freedom</div>
  </div>
</div>
<div id="damageFlash"></div>
<div id="crosshair"><div class="h"></div><div class="v"></div></div>
<div id="handsOverlay">
  <div class="hand left"><div class="finger"></div><div class="finger"></div><div class="finger"></div><div class="finger"></div><div class="pl"></div><div class="pl"></div><div class="pl"></div></div>
  <div class="hand right"><div class="finger"></div><div class="finger"></div><div class="finger"></div><div class="finger"></div><div class="pl"></div><div class="pl"></div><div class="pl"></div></div>
</div>
<div id="endScreen">
  <h1 id="endTitle"></h1>
  <div class="stat" id="endStats"></div>
  <button class="end-btn" onclick="location.reload()">TRY AGAIN</button>
  <a class="end-btn home" href="berlin.html">RETURN HOME</a>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
const STRIP_LEN = 150, STRIP_W = 50, WALL_H = 3.6, TOWER_H = 10;
let scene, cam, renderer, clock;
let player = {x:0,y:1.7,z:2,vx:0,vy:0,vz:0,onGround:true};
let guards=[], bullets=[], barbedWires=[], colliders=[];
let gameState='menu', health=150, timer=0;
let keys={}, yaw=0, pitch=0, ptrLocked=false;
let climbT=0, isClimbing=false, lastBarbDmg=0;

function mm(c,r,m){return new THREE.MeshStandardMaterial({color:c,roughness:r||0.9,metalness:m||0})}

function init(){
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x0c0e10);
  scene.fog=new THREE.FogExp2(0x0c0e10,0.01);
  cam=new THREE.PerspectiveCamera(72,innerWidth/innerHeight,0.1,400);
  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  renderer.shadowMap.enabled=true;
  renderer.shadowMap.type=THREE.PCFSoftShadowMap;
  renderer.toneMapping=THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure=0.45;
  document.body.appendChild(renderer.domElement);
  clock=new THREE.Clock();
  buildWorld();
  setupLights();
  setupInput();
  window.addEventListener('resize',()=>{cam.aspect=innerWidth/innerHeight;cam.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight)});
}

function buildWorld(){
  // Ground
  let g=new THREE.Mesh(new THREE.PlaneGeometry(STRIP_W+40,STRIP_LEN+60),mm(0x3a3528,1));
  g.rotation.x=-Math.PI/2;g.position.set(0,0,STRIP_LEN/2);g.receiveShadow=true;scene.add(g);
  // Extended
  [[-60],[STRIP_LEN+80]].forEach(z=>{let e=new THREE.Mesh(new THREE.PlaneGeometry(200,200),mm(0x1f1d18,1));e.rotation.x=-Math.PI/2;e.position.set(0,-0.02,z[0]);scene.add(e)});

  // Walls
  buildWall(0,false);
  buildWall(STRIP_LEN,true);

  // Sides
  [-STRIP_W/2, STRIP_W/2].forEach(x=>{
    let s=new THREE.Mesh(new THREE.BoxGeometry(0.6,4,STRIP_LEN+30),mm(0x444444));
    s.position.set(x,2,STRIP_LEN/2);s.castShadow=true;scene.add(s);
    colliders.push({x1:x-0.3,x2:x+0.3,z1:-10,z2:STRIP_LEN+20});
  });

  // Barbed wire at 4 positions
  [18,48,82,118].forEach(z=>buildBarbed(z));

  // Trenches
  [33,98].forEach(z=>buildTrench(z));

  // Towers
  [[-STRIP_W/2+3,8],[STRIP_W/2-3,8],[-STRIP_W/2+3,55],[STRIP_W/2-3,55],[-STRIP_W/2+3,110],[STRIP_W/2-3,110]].forEach(([x,z])=>buildTower(x,z));

  // East buildings (bricked windows)
  [[-14,-22,12,18,11],[ 11,-28,14,20,15],[-7,-48,15,16,13],[19,-42,10,22,17]].forEach(b=>buildBldg(b[0],b[1],b[2],b[3],b[4],true));
  // West buildings (lit windows)
  [[-11,STRIP_LEN+22,13,16,12],[14,STRIP_LEN+28,11,18,10],[1,STRIP_LEN+45,17,14,16]].forEach(b=>buildBldg(b[0],b[1],b[2],b[3],b[4],false));

  // Floodlights
  for(let z=12;z<STRIP_LEN;z+=22){buildLight(-STRIP_W/2+4,z);buildLight(STRIP_W/2-4,z)}

  // Concrete debris
  for(let i=0;i<25;i++){
    let x=(Math.random()-0.5)*(STRIP_W-8),z=8+Math.random()*(STRIP_LEN-16),s=0.4+Math.random()*1.2;
    let b=new THREE.Mesh(new THREE.BoxGeometry(s,s*0.5,s*0.8),mm(0x444038));
    b.position.set(x,s*0.25,z);b.rotation.y=Math.random()*Math.PI;b.castShadow=true;scene.add(b);
    colliders.push({x1:x-s/2,x2:x+s/2,z1:z-s*0.4,z2:z+s*0.4,h:s*0.5});
  }

  // Guards — patrol
  [[-7,22],[9,42],[-4,68],[11,88],[0,132]].forEach(([x,z])=>spawnGuard(x,z,'patrol'));
  // Guards — tower
  [[-STRIP_W/2+3,8],[STRIP_W/2-3,8],[-STRIP_W/2+3,55],[STRIP_W/2-3,55],[-STRIP_W/2+3,110],[STRIP_W/2-3,110]].forEach(([x,z])=>spawnGuard(x,z,'tower',TOWER_H-1));
}

function buildWall(z,isWest){
  let w=new THREE.Mesh(new THREE.BoxGeometry(STRIP_W+10,WALL_H,0.4),mm(isWest?0x666666:0x555555,0.85));
  w.position.set(0,WALL_H/2,z);w.castShadow=true;w.receiveShadow=true;scene.add(w);
  // Pipe
  let p=new THREE.Mesh(new THREE.CylinderGeometry(0.07,0.07,STRIP_W+10,8),mm(0x999999,0.3,0.7));
  p.rotation.z=Math.PI/2;p.position.set(0,WALL_H+0.07,z);scene.add(p);
  // Horizontal lines on wall face
  for(let y=0.4;y<WALL_H;y+=0.3){
    let ln=new THREE.Mesh(new THREE.PlaneGeometry(STRIP_W+10,0.015),new THREE.MeshBasicMaterial({color:0x333333,transparent:true,opacity:0.2}));
    ln.position.set(0,y,z+0.21);scene.add(ln);
  }
  if(isWest) colliders.push({x1:-STRIP_W/2-5,x2:STRIP_W/2+5,z1:z-0.25,z2:z+0.25,climb:true,west:true});
  else colliders.push({x1:-STRIP_W/2-5,x2:STRIP_W/2+5,z1:z-0.25,z2:z+0.25});
}

function buildBarbed(z){
  let gr=new THREE.Group();
  for(let x=-STRIP_W/2+2;x<=STRIP_W/2-2;x+=3.5){
    let po=new THREE.Mesh(new THREE.CylinderGeometry(0.035,0.035,1.4,5),mm(0x555555,0.5,0.6));
    po.position.set(x,0.7,z);gr.add(po);
  }
  for(let h=0.35;h<=1.25;h+=0.3){
    let wi=new THREE.Mesh(new THREE.CylinderGeometry(0.008,0.008,STRIP_W-4,4),mm(0x777777,0.3,0.8));
    wi.rotation.z=Math.PI/2;wi.position.set(0,h,z);gr.add(wi);
    // Barb spikes
    for(let x=-STRIP_W/2+3;x<STRIP_W/2-2;x+=1.2){
      let sp=new THREE.Mesh(new THREE.ConeGeometry(0.025,0.07,3),mm(0x999999,0.3,0.7));
      sp.position.set(x,h+0.03,z);sp.rotation.z=Math.random()*6;gr.add(sp);
    }
  }
  scene.add(gr);
  barbedWires.push({z1:z-0.7,z2:z+0.7,yMax:1.4});
}

function buildTrench(z){
  let t=new THREE.Mesh(new THREE.BoxGeometry(STRIP_W-6,1.0,2.8),mm(0x151310,1));
  t.position.set(0,-0.5,z);scene.add(t);
}

function buildTower(x,z){
  let gr=new THREE.Group();
  [[-1.4,-1.4],[1.4,-1.4],[1.4,1.4],[-1.4,1.4]].forEach(([dx,dz])=>{
    let l=new THREE.Mesh(new THREE.BoxGeometry(0.25,TOWER_H-2,0.25),mm(0x555550,0.8));
    l.position.set(dx,(TOWER_H-2)/2,dz);l.castShadow=true;gr.add(l);
  });
  // Cross braces
  for(let h=2;h<TOWER_H-3;h+=3){
    let br=new THREE.Mesh(new THREE.BoxGeometry(0.08,0.08,4),mm(0x555550));
    br.position.set(0,h,0);br.rotation.y=Math.PI/4;gr.add(br);
  }
  let pl=new THREE.Mesh(new THREE.BoxGeometry(4.5,0.25,4.5),mm(0x444440));
  pl.position.set(0,TOWER_H-2,0);pl.castShadow=true;gr.add(pl);
  let cb=new THREE.Mesh(new THREE.BoxGeometry(3.8,2.4,3.8),mm(0x3a3835,0.85));
  cb.position.set(0,TOWER_H-0.6,0);cb.castShadow=true;gr.add(cb);
  // Windows on all sides
  [[0,0,1.91],[0,0,-1.91],[1.91,0,0],[-1.91,0,0]].forEach(([wx,_,wz],i)=>{
    let wi=new THREE.Mesh(new THREE.PlaneGeometry(1.3,0.9),new THREE.MeshStandardMaterial({color:0x112233,roughness:0.3,metalness:0.5,transparent:true,opacity:0.7}));
    wi.position.set(wx,TOWER_H-0.4,wz);if(i>=2)wi.rotation.y=Math.PI/2;gr.add(wi);
  });
  let rf=new THREE.Mesh(new THREE.BoxGeometry(4.2,0.12,4.2),mm(0x333330));
  rf.position.set(0,TOWER_H+0.6,0);gr.add(rf);

  // Spotlight from tower
  let sp=new THREE.SpotLight(0xffeedd,0.6,45,Math.PI/5,0.4,1.5);
  sp.position.set(0,TOWER_H-0.5,0);
  sp.target.position.set(x>0?-10:10,0,z);
  sp.castShadow=true;sp.shadow.mapSize.set(512,512);
  gr.add(sp);gr.add(sp.target);

  gr.position.set(x,0,z);scene.add(gr);
}

function buildBldg(x,z,w,d,h,bricked){
  let b=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),mm(bricked?0x3d3328:0x4a4540,0.9));
  b.position.set(x,h/2,z);b.castShadow=true;scene.add(b);
  let rows=Math.floor(h/3.2),cols=Math.floor(w/3);
  for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
    let wy=2.5+r*3.2,wx=x-w/2+1.8+c*3;
    let wm;
    if(bricked){wm=mm(0x2a2218,0.95)}
    else{let lit=Math.random()>0.35;wm=new THREE.MeshStandardMaterial({color:lit?0xffe8a0:0x1a1a1a,roughness:0.5,emissive:lit?0x443300:0,emissiveIntensity:lit?0.5:0})}
    let wg=new THREE.PlaneGeometry(1.1,1.5);
    let f=new THREE.Mesh(wg,wm);f.position.set(wx,wy,z+d/2+0.01);scene.add(f);
    let bk=new THREE.Mesh(wg,wm);bk.position.set(wx,wy,z-d/2-0.01);bk.rotation.y=Math.PI;scene.add(bk);
  }
}

function buildLight(x,z){
  let po=new THREE.Mesh(new THREE.CylinderGeometry(0.06,0.1,6.5,6),mm(0x555555,0.5,0.5));
  po.position.set(x,3.25,z);po.castShadow=true;scene.add(po);
  let ho=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.25,0.35),mm(0x777770,0.4,0.5));
  ho.position.set(x,6.7,z);scene.add(ho);
  let sl=new THREE.SpotLight(0xffeedd,0.5,35,Math.PI/4.5,0.5,1.8);
  sl.position.set(x,6.5,z);sl.target.position.set(x>0?x-7:x+7,0,z);
  sl.castShadow=true;sl.shadow.mapSize.set(256,256);
  scene.add(sl);scene.add(sl.target);
}

function spawnGuard(x,z,type,elev){
  let gr=new THREE.Group(),y=elev||0;
  // Body - dark green NVA Grenztruppen uniform
  let body=new THREE.Mesh(new THREE.BoxGeometry(0.45,0.95,0.3),mm(0x2a3a20));body.position.y=1.18;gr.add(body);
  // Belt
  let belt=new THREE.Mesh(new THREE.BoxGeometry(0.48,0.08,0.32),mm(0x1a1a10,0.6,0.3));belt.position.y=0.78;gr.add(belt);
  // Head
  let head=new THREE.Mesh(new THREE.SphereGeometry(0.16,8,8),mm(0xc4956a));head.position.y=1.8;gr.add(head);
  // Helmet - stahlhelm style
  let helm=new THREE.Mesh(new THREE.SphereGeometry(0.2,8,6,0,Math.PI*2,0,Math.PI*0.55),mm(0x2a3520,0.6,0.3));
  helm.position.y=1.88;gr.add(helm);
  // Legs
  [[-0.1,0.34],[0.1,0.34]].forEach(([lx,ly])=>{
    let l=new THREE.Mesh(new THREE.BoxGeometry(0.16,0.65,0.18),mm(0x2a3a20));l.position.set(lx,ly,0);gr.add(l);
  });
  // Boots
  [[-0.1,0.05],[0.1,0.05]].forEach(([bx,by])=>{
    let b=new THREE.Mesh(new THREE.BoxGeometry(0.17,0.25,0.24),mm(0x111111,0.6,0.2));b.position.set(bx,by,0.02);gr.add(b);
  });
  // Arms
  [[-0.28,1.15],[0.28,1.15]].forEach(([ax,ay])=>{
    let a=new THREE.Mesh(new THREE.BoxGeometry(0.11,0.5,0.12),mm(0x2a3a20));a.position.set(ax,ay,0.05);gr.add(a);
  });
  // SMG
  let gun=new THREE.Mesh(new THREE.BoxGeometry(0.05,0.05,0.55),mm(0x1a1a1a,0.4,0.6));gun.position.set(0.22,1.1,0.22);gr.add(gun);
  let mag=new THREE.Mesh(new THREE.BoxGeometry(0.04,0.15,0.04),mm(0x1a1a1a,0.4,0.6));mag.position.set(0.22,1.02,0.15);gr.add(mag);

  gr.position.set(x,y,z);gr.castShadow=true;scene.add(gr);
  guards.push({mesh:gr,type,x,z,y,bx:x,bz:z,dir:1,range:10+Math.random()*10,spd:1+Math.random()*0.8,cd:0,detected:false,alert:0});
}

function setupLights(){
  scene.add(new THREE.AmbientLight(0x1a1a22,0.25));
  let moon=new THREE.DirectionalLight(0x667799,0.15);
  moon.position.set(20,40,30);moon.castShadow=true;
  moon.shadow.mapSize.set(2048,2048);
  let sc=moon.shadow.camera;sc.left=-80;sc.right=80;sc.top=80;sc.bottom=-80;sc.far=150;
  scene.add(moon);
  let fill=new THREE.DirectionalLight(0x332200,0.08);fill.position.set(0,10,-20);scene.add(fill);
}

function setupInput(){
  document.addEventListener('keydown',e=>{keys[e.code]=true});
  document.addEventListener('keyup',e=>{keys[e.code]=false});
  document.addEventListener('mousemove',e=>{
    if(ptrLocked){yaw-=e.movementX*0.002;pitch-=e.movementY*0.002;pitch=Math.max(-1.4,Math.min(1.4,pitch))}
  });
  renderer.domElement.addEventListener('click',()=>{if(gameState==='playing'&&!ptrLocked)renderer.domElement.requestPointerLock()});
  document.addEventListener('pointerlockchange',()=>{ptrLocked=document.pointerLockElement===renderer.domElement});
}

document.getElementById('startBtn').onclick=function(){
  document.getElementById('startScreen').style.display='none';
  document.getElementById('hud').style.display='flex';
  document.getElementById('crosshair').style.display='block';
  document.getElementById('handsOverlay').style.display='block';
  gameState='playing';health=150;timer=0;
  player={x:0,y:1.7,z:2,vx:0,vy:0,vz:0,onGround:true};
  yaw=0;pitch=0;
  init();animate();
};

function animate(){
  if(gameState!=='playing')return;
  requestAnimationFrame(animate);
  let dt=Math.min(clock.getDelta(),0.05);
  timer+=dt;
  updatePlayer(dt);
  updateGuards(dt);
  updateBullets(dt);
  checkBarbed();
  checkWin();
  updateHUD();
  cam.position.set(player.x,player.y,player.z);
  cam.rotation.order='YXZ';cam.rotation.y=yaw;cam.rotation.x=pitch;
  renderer.render(scene,cam);
}

function updatePlayer(dt){
  let sprint=keys['ShiftLeft']||keys['ShiftRight'];
  let spd=sprint?6.5:3.5;
  let lk=2.2*dt;
  if(keys['ArrowLeft'])yaw+=lk;
  if(keys['ArrowRight'])yaw-=lk;
  if(keys['ArrowUp'])pitch=Math.min(pitch+lk,1.4);
  if(keys['ArrowDown'])pitch=Math.max(pitch-lk,-1.4);

  let mx=0,mz=0;
  if(keys['KeyW'])mz=1;if(keys['KeyS'])mz=-1;
  if(keys['KeyA'])mx=1;if(keys['KeyD'])mx=-1;
  let sY=Math.sin(yaw),cY=Math.cos(yaw);
  let dx=mx*cY-mz*sY, dz=mx*sY+mz*cY;
  let ln=Math.sqrt(dx*dx+dz*dz);
  if(ln>0){dx/=ln;dz/=ln}

  player.vx=dx*spd;player.vz=dz*spd;
  if(keys['Space']&&player.onGround){player.vy=5.5;player.onGround=false}
  player.vy-=14*dt;

  let nx=player.x+player.vx*dt, nz=player.z+player.vz*dt, ny=player.y+player.vy*dt;

  isClimbing=false;
  for(let c of colliders){
    if(c.climb&&nx>c.x1&&nx<c.x2&&nz>c.z1-1.2&&nz<c.z2+1.2){
      if(keys['Space']){
        isClimbing=true;player.vy=3;ny=player.y+player.vy*dt;
        if(player.y>WALL_H+1.7){nz=c.z2+1.5}
      }
    }
    if(!c.west&&!c.climb&&nx>c.x1&&nx<c.x2&&nz>c.z1&&nz<c.z2){nx=player.x;nz=player.z}
  }

  if(ny<1.7){ny=1.7;player.vy=0;player.onGround=true}
  nx=Math.max(-STRIP_W/2+0.8,Math.min(STRIP_W/2-0.8,nx));
  player.x=nx;player.y=ny;player.z=nz;

  // Hand animation
  let ho=document.getElementById('handsOverlay');
  if(isClimbing){climbT+=dt*5;ho.classList.add('climbing');ho.classList.toggle('alt',Math.floor(climbT)%2===0)}
  else{ho.classList.remove('climbing','alt');
    if(ln>0){let bob=Math.sin(timer*(sprint?13:8))*3;ho.style.transform=`translateX(-50%) translateY(${bob}px)`}
    else ho.style.transform='translateX(-50%)'
  }
}

function updateGuards(dt){
  for(let g of guards){
    let dx=player.x-g.x,dz=player.z-g.z,dy=player.y-(g.y+1.7);
    let dist=Math.sqrt(dx*dx+dy*dy+dz*dz);
    let range=g.type==='tower'?50:33;
    let see=dist<range;
    if(g.type==='patrol'&&see){
      let fw=new THREE.Vector3(Math.sin(g.mesh.rotation.y),0,Math.cos(g.mesh.rotation.y));
      let tp=new THREE.Vector3(dx,0,dz).normalize();
      if(fw.dot(tp)<0.25)see=false;
    }
    if(see)g.alert=Math.min(g.alert+dt*2.5,1);else g.alert=Math.max(g.alert-dt*0.4,0);
    g.detected=g.alert>0.5;

    if(g.detected){
      g.mesh.rotation.y=Math.atan2(dx,dz);
      g.cd-=dt;
      if(g.cd<=0&&dist<range){shoot(g);g.cd=0.12+Math.random()*0.18}
    }
    if(g.type==='patrol'&&!g.detected){
      g.x+=g.dir*g.spd*dt;
      if(Math.abs(g.x-g.bx)>g.range/2)g.dir*=-1;
      g.mesh.position.x=g.x;
      g.mesh.rotation.y=g.dir>0?Math.PI/2:-Math.PI/2;
    }
  }
}

function shoot(g){
  let dx=player.x-g.x,dy=player.y-(g.y+1.5),dz=player.z-g.z;
  let d=Math.sqrt(dx*dx+dy*dy+dz*dz);
  let sp=0.065;
  let dir=new THREE.Vector3(dx/d+(Math.random()-0.5)*sp,dy/d+(Math.random()-0.5)*sp,dz/d+(Math.random()-0.5)*sp).normalize();
  let bm=new THREE.Mesh(new THREE.SphereGeometry(0.03,4,4),new THREE.MeshBasicMaterial({color:0xffaa33}));
  bm.position.set(g.x,g.y+1.5,g.z);scene.add(bm);
  // Tracer line
  let tg=new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(g.x,g.y+1.5,g.z),new THREE.Vector3(g.x+dir.x*3,g.y+1.5+dir.y*3,g.z+dir.z*3)]);
  let tl=new THREE.Line(tg,new THREE.LineBasicMaterial({color:0xff8800,transparent:true,opacity:0.4}));
  scene.add(tl);setTimeout(()=>scene.remove(tl),80);

  bullets.push({mesh:bm,dir,spd:85,life:2});
}

function updateBullets(dt){
  for(let i=bullets.length-1;i>=0;i--){
    let b=bullets[i];
    b.mesh.position.x+=b.dir.x*b.spd*dt;
    b.mesh.position.y+=b.dir.y*b.spd*dt;
    b.mesh.position.z+=b.dir.z*b.spd*dt;
    b.life-=dt;
    let dx=b.mesh.position.x-player.x,dy=b.mesh.position.y-player.y,dz=b.mesh.position.z-player.z;
    if(Math.sqrt(dx*dx+dy*dy+dz*dz)<0.5){dmg(4);scene.remove(b.mesh);bullets.splice(i,1);continue}
    if(b.life<=0||b.mesh.position.y<-1){scene.remove(b.mesh);bullets.splice(i,1)}
  }
}

function checkBarbed(){
  for(let bw of barbedWires){
    if(player.z>bw.z1&&player.z<bw.z2&&player.y-0.7<bw.yMax){
      if(timer-lastBarbDmg>0.5){dmg(20);lastBarbDmg=timer}
    }
  }
}

function dmg(n){
  health=Math.max(0,health-n);
  let f=document.getElementById('damageFlash');f.style.opacity='1';setTimeout(()=>f.style.opacity='0',120);
  if(health<=0)endGame(false);
}

function checkWin(){if(player.z>STRIP_LEN+1.5&&player.y>WALL_H)endGame(true)}

function endGame(won){
  gameState=won?'won':'dead';
  let el=document.getElementById('endScreen');
  el.className='show '+(won?'victory':'defeat');
  document.getElementById('endTitle').textContent=won?'FREEDOM':'KILLED IN ACTION';
  document.getElementById('endStats').innerHTML=won?
    `Time: <strong>${fmt(timer)}</strong><br>Health: <strong>${health}/150</strong><br><br>You crossed the death strip.<br>You are free.`:
    `Survived: <strong>${fmt(timer)}</strong><br>Distance: <strong>${Math.floor(player.z)}m / ${STRIP_LEN}m</strong><br><br>Between 1961 and 1989, at least 140 people<br>died attempting to cross the Berlin Wall.`;
  document.getElementById('hud').style.display='none';
  document.getElementById('crosshair').style.display='none';
  document.getElementById('handsOverlay').style.display='none';
  if(ptrLocked)document.exitPointerLock();
}

function fmt(t){let m=Math.floor(t/60),s=Math.floor(t%60);return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')}

function updateHUD(){
  let p=(health/150)*100,bar=document.getElementById('healthBar');
  bar.style.width=p+'%';bar.className='health-bar-inner'+(p<30?' low':'');
  document.getElementById('timerDisplay').textContent=fmt(timer);
  document.getElementById('distDisplay').textContent=Math.max(0,Math.floor(STRIP_LEN-player.z))+'m to freedom';
}
</script>
</body>
</html>
